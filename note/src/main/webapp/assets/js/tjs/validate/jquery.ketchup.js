(function(e){e.ketchup={defaults:{delimit:",",attribute:"data-validate",validateIndicator:"validate",eventIndicator:"on",validateEvents:"blur",bindElement:null,bindEvent:"click",showEvent:"click",bindForm:!0,targetPosition:"leftdown",zIndex:1e5,validateElements:["input","textarea","select"],createErrorContainer:null,appendTo:"body",containerRelative:null,containerClass:null,showErrorContainer:null,hideErrorContainer:null,addErrorMessages:null,removeErrorContainer:null,hideAllErrorContainer:null},dataNames:{validationString:"ketchup-validation-string",validations:"ketchup-validations",events:"ketchup-events",elements:"ketchup-validation-elements",container:"ketchup-container"},validations:{},helpers:{},validation:function(){var e,t,n=arguments[1];return typeof n=="function"?t=n:(e=n,t=arguments[2]),this.validations[arguments[0]]={message:e,func:t,init:arguments[3]||function(e,t){}},this},message:function(e,t){return this.addMessage(e,t),this},messages:function(e){for(name in e)this.addMessage(name,e[name]);return this},addMessage:function(e,t){this.validations[e]&&(this.validations[e].message=t)},helper:function(e,t){return this.helpers[e]=t,this},init:function(t,n,r){this.options=n;var i=this,s=this.initFunctions().initFields(t,r);s.each(function(){var n=e(this);i.bindValidationEvent(t,n).callInitFunctions(t,n)}),t.data(this.dataNames.elements,s),n.bindForm&&(this.bindFormSubmit(t),this.bindFormReset(t))},initFunctions:function(){var e=this.options,t=["createErrorContainer","showErrorContainer","hideErrorContainer","addErrorMessages","removeErrorContainer","hideAllErrorContainer"];for(var n=0;n<t.length;n++){var r=t[n];e[r]||(e[r]=this[r])}return this},initFields:function(t,n){var r=this,i=this.dataNames,s=e(n?this.fieldsFromObject(t,n):this.fieldsFromForm(t));return s.each(function(){var t=e(this),n=r.extractValidations(t.data(i.validationString),r.options.validateIndicator);t.data(i.validations,n)}),s},callInitFunctions:function(e,t){var n=t.data(this.dataNames.validations);for(var r=0;r<n.length;r++)n[r].init.apply(this.helpers,[e,t])},fieldsFromForm:function(t){var n=this,r=this.options,i=this.dataNames,s=r.validateElements,o=[];s=typeof s=="string"?[s]:s;for(var u=0;u<s.length;u++){var a=t.find(s[u]+"["+r.attribute+"*="+r.validateIndicator+"]");a.each(function(){var t=e(this),s=t.attr(r.attribute),o=n.extractEvents(s,r.eventIndicator);t.data(i.validationString,s).data(i.events,o?o:r.validateEvents)}),o.push(a.get())}return this.normalizeArray(o)},fieldsFromObject:function(e,t){var n=this.options,r=this.dataNames,i=[];for(s in t){var o,u;typeof t[s]=="string"?(o=t[s],u=n.validateEvents):(o=t[s][0],u=t[s][1]);var a=e.find(s);o=this.mergeValidationString(a,o),u=this.mergeEventsString(a,u),a.data(r.validationString,n.validateIndicator+"("+o+")").data(r.events,u),i.push(a.get())}return this.normalizeArray(i)},mergeEventsString:function(t,n){var r=t.data(this.dataNames.events),i="";if(r){var s=r.split(" ");for(var o=0;o<s.length;o++)n.indexOf(s[o])==-1&&(i+=" "+s[o])}return e.trim(n+i)},mergeValidationString:function(e,t){var n=this.options,r=e.data(this.dataNames.validationString),i=function(e){var t=e.name;return e.arguments.length&&(t=t+"("+e.arguments.join(",")+")"),t},s=function(e,t){for(var n=0;n<e.length;n++)if(e[n].name==t.name)return!0};if(r){var o=this.extractValidations(n.validateIndicator+"("+t+")",n.validateIndicator),u=this.extractValidations(r,n.validateIndicator);t="";for(var a=0;a<u.length;a++)t+=i(u[a])+",";for(var f=0;f<o.length;f++)s(u,o[f])||(t+=i(o[f])+",")}return t},bindFormSubmit:function(t){var n=this,r=this.options;if(r.bindElement){var i=r.bindEvent?r.bindEvent:"click";typeof r.bindElement=="string"&&(r.bindElement=r.bindElement.indexOf("#")>=0?r.bindElement:"#"+r.bindElement,r.bindElement=e(r.bindElement)),r.bindElement.off(i).on(i,function(e){e.preventDefault();var r=n.allFieldsValid(t,!0);return e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,r})}else t.submit(function(){return n.allFieldsValid(t,!0)})},bindFormReset:function(t){var n=this;t.find("input:reset").click(function(){t.data(n.dataNames.elements).each(function(){e(this).removeClass("ketchup-input-error")})}),e(".ketchup-error").each(function(){e(this).css({opacity:0}).hide()})},allFieldsValid:function(t,n){var r=this,i=!0;return t.data(this.dataNames.elements).each(function(){var s=e(this);r.validateElement(s,t)!=1&&(n==1&&r.triggerValidationEvents(s),i=!1)}),t.trigger("formIs"+(i?"Valid":"Invalid"),[t]),i},bindValidationEvent:function(e,t){var n=this,r=this.options,i=this.dataNames,s=t.data(i.events).split(" ");for(var o=0;o<s.length;o++)t.off("ketchup."+s[o]).on("ketchup."+s[o],function(s){var o=n.validateElement(t,e),u=t.data(i.container);o!=1?(u||(u=r.createErrorContainer(e,t,s.namespace,n),t.data(i.container,u)),r.addErrorMessages(e,t,u,o),t.addClass("ketchup-input-error"),s.namespace=="show"?(r.showErrorContainer(e,t,u),setTimeout(function(){r.removeErrorContainer(n,t,u)},3e3)):s.namespace!="blur"&&s.namespace!="hide"?r.showErrorContainer(e,t,u):s.namespace!="hide"&&(r.showEvent!="click"?t.one("mouseover",function(){r.showErrorContainer(e,t,u)}):t.one("click",function(){r.showErrorContainer(e,t,u)})),t.one("blur",function(){r.hideErrorContainer(e,t,u)})):u&&(t.removeClass("ketchup-input-error"),(t.attr("type")=="radio"||t.attr("type")=="checkbox")&&e.find("input[name='"+t.attr("name")+"']").removeClass("ketchup-input-error"),r.hideErrorContainer(e,t,u))}),this.bindValidationEventBridge(t,s[o]);return this},bindValidationEventBridge:function(e,t){e.off(t).on(t,function(){e.trigger("ketchup."+t)})},validateElement:function(t,n){var r=[],i=t.data(this.dataNames.validations),s=[n,t,e.trim(t.val())];for(var o=0;o<i.length;o++){var u=i[o].func.apply(this.helpers,s.concat(i[o].arguments));typeof u=="boolean"?u||r.push(i[o].message):u.result||r.push(u.message)}return n.trigger("fieldIs"+(r.length?"Invalid":"Valid"),[n,t]),r.length?r:!0},elementIsValid:function(e){var t=this.dataNames;if(e.data(t.validations)){var n=e.parentsUntil("form").last().parent(),r=this.validateElement(e,n)==1?!0:!1;return r?e.removeClass("ketchup-input-error"):e.addClass("ketchup-input-error"),r}return e.data(t.elements)?this.allFieldsValid(e):null},triggerValidationEvents:function(e){var t=e.data(this.dataNames.events).split(" ");for(var n=0;n<t.length;n++)e.trigger("ketchup."+t[n])},extractValidations:function(t,n){var r=t.substr(t.indexOf(n)+n.length+1),i="",s=[],o=0,u=0,a=[];for(var f=0;f<r.length;f++)switch(r.charAt(f)){case"(":i+="(",o++;break;case")":o?(i+=")",o--):s.push(e.trim(i));break;case",":o?i+=",":u?u==2?(s.push(e.trim(i)),i="",u=0):i+=r.charAt(f):(s.push(e.trim(i)),i="",u=0);break;case":":u++,u==1&&(i+=r.charAt(f));break;default:i+=r.charAt(f)}for(var l=0;l<s.length;l++){var c=s[l].indexOf("("),h=s[l],p=[];if(c!=-1){h=e.trim(s[l].substr(0,c));var d=s[l].substr(h.length);this.defaults.delimit===","?d.indexOf("^")>0&&d.indexOf("$")>0?p=e.map(s[l].substr(h.length+1).split("$"),function(t,n){if(n==0){var r=t.indexOf("^");return r+1!=t.indexOf("\\")&&(t=t.substring(0,r+1)+"\\"+t.substring(r+1)),e.trim(t+"$")}return e.trim(t.replace("(","").replace(")",""))}):p=e.map(s[l].substr(h.length).split(this.defaults.delimit),function(t){return e.trim(t.replace("(","").replace(")",""))}):p=e.map(d.split(this.defaults.delimit),function(t){return e.trim(t.replace("(","").replace(")",""))})}var v=h.split(":");h=v[0];var m=this.validations[h];if(m&&m.message){var g=m.message;v[1]&&(g=v[1]);for(var y=1;y<=p.length;y++)g=g.replace("{arg"+y+"}",p[y-1]);a.push({name:h,arguments:p,func:m.func,message:g,init:m.init})}}return a},extractEvents:function(e,t){var n=!1,r=e.indexOf(t+"(");return r!=-1&&(n=e.substr(r+t.length+1).split(")")[0]),n},normalizeArray:function(e){var t=[];for(var n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)e[n][r]&&t.push(e[n][r]);return t},createErrorContainer:function(t,n,r,i){if(typeof t=="function")return i.defaults.createErrorContainer=t,t;var s=n.offset(),o=s.left,u=s.top;this.containerRelative&&(o=0,u=0);var a=Math.max(document.documentElement.scrollWidth,document.documentElement.clientWidth);this.targetPosition=="leftdown"?o=s.left+n.outerWidth()+100>a?o+n.outerWidth()/2-50:o+n.outerWidth()-20:this.targetPosition=="rightdown"?o=s.left>n.outerWidth()?o-n.outerWidth()+50:o/2-20:this.targetPosition=="centerdown"||this.targetPosition=="centerup"?(o=s.left+n.outerWidth()/20-10,this.containerRelative&&(o=n.outerWidth()/2,u=this.containerRelative?u:u+n.outerHeight()+12)):this.targetPosition=="rightcenter"&&(o=s.left+n.outerWidth()),this.targetPosition.indexOf("up")>0&&(u=u+n.outerHeight()+52),o<0&&(o=5),o-=1;var f=n.attr("type");if(f=="radio"||f=="checkbox"){var l=e("input[type="+f+"][name='"+n.attr("name")+"']",t).size();o-=20*l}var c=null;return this.targetPosition.indexOf("up")>0||this.targetPosition=="rightcenter"?r=="blur"?c=e('<div class="ketchup-error"><span class='+this.targetPosition+"></span><ul></ul></div>").css({top:u,left:o,opacity:0,display:"none"}):c=e('<div class="ketchup-error"><span class='+this.targetPosition+"></span><ul></ul></div>").css({top:u,left:o,"z-index":this.zIndex}):r=="blur"?c=e('<div class="ketchup-error"><ul></ul><span class='+this.targetPosition+"></span></div>").css({top:u,left:o,opacity:0,display:"none"}):c=e('<div class="ketchup-error"><ul></ul><span class='+this.targetPosition+"></span></div>").css({top:u,left:o,"z-index":this.zIndex}),typeof this.appendTo=="function"?this.appendTo.apply(this,[c,n]):this.appendTo?c.appendTo(this.appendTo):c.appendTo("body"),typeof this.containerClass!="undefined"&&!!this.containerClass&&c.addClass(this.containerClass),c},showErrorContainer:function(t,n,r){if(typeof t=="function")return this.defaults.showErrorContainer=t,this;var i=n.offset(),s=i.left,o=i.top;this.containerRelative&&(s=0,o=0);var u=Math.max(document.documentElement.scrollWidth,document.documentElement.clientWidth);this.targetPosition=="leftdown"?s=s+n.outerWidth()+r.outerWidth()>u?u-r.outerWidth()-10:s+n.outerWidth()-20:this.targetPosition=="rightdown"?s=s>r.outerWidth()?s-r.outerWidth()+10:s-r.outerWidth():this.targetPosition=="centerdown"||this.targetPosition=="centerup"?(s=s+n.outerWidth()/5-10,this.containerRelative&&(s=n.outerWidth()/2+10)):this.targetPosition=="rightcenter"&&(s=s+n.outerWidth()+20,this.containerRelative&&(o=this.containerRelative.top,s=this.containerRelative.left)),this.targetPosition.indexOf("up")>0&&(this.containerRelative?o=o+n.outerHeight()+22:o=o+n.outerHeight()+52),s<0&&(s=5),(n.attr("type")=="radio"||n.attr("type")=="checkbox")&&e(".ketchup-error").each(function(){e(this).index()!=r.index()&&e(this).hide()}),r.css({top:o,left:s});var a=r.height();r.find("ul").height()>0?a=r.data("height",r.height()):a=r.data("height")+2,this.targetPosition.indexOf("up")>0?r.show().animate({top:this.containerRelative?n.outerHeight()+1:n.offset().top+n.outerHeight()+5,opacity:1},"fast"):this.targetPosition=="rightcenter"?r.show().animate({top:this.containerRelative?this.containerRelative.top:n.offset().top,opacity:1},"fast"):r.show().animate({top:this.containerRelative?-r.height():n.offset().top-r.height()-5,opacity:1},"fast")},hideErrorContainer:function(t,n,r){if(typeof t=="function")return this.defaults.hideErrorContainer=t,this;(n.attr("type")=="radio"||n.attr("type")=="checkbox")&&e(".ketchup-error").each(function(){e(this).index()!=r.index()&&e(this).hide()}),this.targetPosition.indexOf("up")>0?r.show().animate({top:this.containerRelative?0:n.offset().top+r.height(),opacity:0},"fast",function(){r.hide()}):r.animate({top:this.containerRelative?0:n.offset().top,opacity:0},"fast",function(){r.hide()})},removeErrorContainer:function(t,n,r){var i=this;if(typeof t!="undefined"&&t&&t.length>0){if(i.dataNames&&i.dataNames.elements&&t.data(i.dataNames.elements)){var s=t.data(i.dataNames.elements);s.each(function(){var t=e(this);if(t.data(i.dataNames.events)){var n=t.data(i.dataNames.events).split(" ");for(var r=0;r<n.length;r++)t.off(n[r]).off("ketchup."+n[r]);t.removeData(i.dataNames.events)}t.data(i.dataNames.container)&&(t.data(i.dataNames.container).remove(),t.removeData(i.dataNames.container)),t.data(i.dataNames.validationString)&&t.removeData(i.dataNames.validationString),t.data(i.dataNames.validations)&&t.removeData(i.dataNames.validations),t.removeClass("ketchup-input-error")})}}else if(typeof t!="undefined"&&t&&typeof n!="undefined"&&n){var i=t;if(n.data(i.dataNames.events)){var o=n.data(i.dataNames.events).split(" ");for(var u=0;u<o.length;u++)n.off(o[u]).off("ketchup."+o[u]);n.removeData(i.dataNames.events)}typeof r!="undefined"&&r&&r.remove(),n.data(i.dataNames.validationString)&&n.removeData(i.dataNames.validationString),n.data(i.dataNames.validations)&&n.removeData(i.dataNames.validations),n.removeClass("ketchup-input-error")}},hideAllErrorContainer:function(t,n){var r=this;r.dataNames&&r.dataNames.elements&&e(t).data(r.dataNames.elements)&&e(t).data(r.dataNames.elements).each(function(){n&&e(this).removeClass("ketchup-input-error"),e(this).data(r.dataNames.container)&&e(this).data(r.dataNames.container).css({opacity:0}).hide()})},addErrorMessages:function(t,n,r,i){if(typeof t=="function")return this.defaults.addErrorMessages=t,this;var s=r.children("ul");s.html("");for(var o=0;o<i.length;o++)e("<li>"+i[o]+"</li>").appendTo(s)}},e.fn.ketchup=function(t,n){var r=e(this);if(typeof t=="string")switch(t){case"validate":e.ketchup.triggerValidationEvents(r);break;case"isValid":return e.ketchup.elementIsValid(r)}else this.each(function(){e.ketchup.init(r,e.extend({},e.ketchup.defaults,t),n)});return this}})(jQuery);